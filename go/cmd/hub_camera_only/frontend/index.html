<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RabbitMQ Video Stream</title>
</head>
<body>
<h1>RabbitMQ Video Stream</h1>
<video id="video" controls autoplay></video> <!-- TODO: muted autoplay -->
<script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
<script>
    var video = document.getElementById('video');
    var hls = new Hls();
    hls.loadSource('http://example.com/live/stream.m3u8');
    hls.attachMedia(video);
</script>

<script>
    const ws = new WebSocket("ws://localhost:8082/ws");
    const mediaSource = new MediaSource();
    const video = document.getElementById("video");
    video.src = URL.createObjectURL(mediaSource);


    // Create a loading message that will appear while buffering
    const loadingMessage = document.createElement("div");
    loadingMessage.textContent = "Buffering video...";
    document.body.appendChild(loadingMessage);

    // WebSocket connection success
    ws.onopen = () => {
        console.log("WebSocket connection established");
    };

    // WebSocket error handling
    ws.onerror = (error) => {
        console.error("WebSocket Error:", error);
    };

    // WebSocket close event handling
    ws.onclose = () => {
        console.log("WebSocket closed");
    };

    mediaSource.addEventListener("sourceopen", () => {
        console.log("MediaSource is open");

        let sourceBuffer;
        try {
            sourceBuffer = mediaSource.addSourceBuffer('video/mp2t')
            // sourceBuffer = mediaSource.addSourceBuffer('video/mp4; codecs="avc1.64001f, mp4a.40.2"');
        } catch (e) {
            console.error("Error adding source buffer:", e);
            return;
        }

        ws.binaryType = "arraybuffer";

        // Handling incoming WebSocket messages
        ws.onmessage = (event) => {
            if (sourceBuffer.updating || !event.data) return;

            console.log("Received data:", event.data);  // Log received data
            try {
                // Append the data to the sourceBuffer
                sourceBuffer.appendBuffer(new Uint8Array(event.data));
            } catch (e) {
                console.error("Error appending buffer:", e);
            }
        };

        // SourceBuffer update end event
        // Listen for updates to the buffer and hide the loading message once buffering is complete
        sourceBuffer.addEventListener('updateend', () => {
            console.log("Buffer updated");
            if (sourceBuffer.buffered.length > 0 && sourceBuffer.buffered.end(0) > 0) {
                loadingMessage.style.display = "none";  // Hide loading message when video is ready
            }
        });
    });

    // Logging any errors with the video player
    video.onerror = (error) => {
        console.error("Video player error:", error);
    };

</script>
</body>
</html>

<!--<!DOCTYPE html>-->
<!--<html lang="en">-->
<!--<head>-->
<!--    <meta charset="UTF-8">-->
<!--    <meta name="viewport" content="width=device-width, initial-scale=1.0">-->
<!--    <title>Live Video Stream</title>-->
<!--</head>-->
<!--<body>-->
<!--<h1>Live Video Feed</h1>-->
<!--<video id="videoElement" controls autoplay></video>-->

<!--<script>-->
<!--    const videoElement = document.getElementById('videoElement');-->
<!--    const ws = new WebSocket('ws://video_consumer:8082');-->

<!--    ws.binaryType = 'blob'; // Handling video data as binary blobs-->
<!--    ws.onmessage = function(event) {-->
<!--        const videoBlob = event.data;-->
<!--        const videoUrl = URL.createObjectURL(videoBlob);-->
<!--        videoElement.src = videoUrl;-->
<!--    };-->

<!--    ws.onopen = function() {-->
<!--        console.log('WebSocket connection established');-->
<!--    };-->

<!--    ws.onerror = function(error) {-->
<!--        console.error('WebSocket Error:', error);-->
<!--    };-->
<!--</script>-->
<!--</body>-->
<!--</html>-->
